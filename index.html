<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Warehouse Dispatch Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      padding: 20px;
      background: #f9f9f9;
      position: relative;
      text-align: right;
    }

    label, select, input, button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      font-size: 1rem;
      padding: 8px;
      box-sizing: border-box;
    }

    button#submitBtn {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button#submitBtn:hover {
      background: #0056b3;
    }

    #accumulatedItems, #previousEntries {
      white-space: pre-wrap;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 80px;
      margin-bottom: 20px;
    }

    h3 {
      margin-top: 30px;
    }

    #langToggle {
      float: right;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.3s ease;
      margin-bottom: 15px;
    }

    #langToggle:hover {
      background: #e0e0e0;
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBJKet_uwrNKLRzJuZBNbgtJzSJ963vpmM",
      authDomain: "code-64718.firebaseapp.com",
      projectId: "code-64718",
      storageBucket: "code-64718.appspot.com",
      messagingSenderId: "976088837146",
      appId: "1:976088837146:web:755a0643e01d2d45d175a3"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>

<div style="overflow: hidden;">
  <button id="langToggle">
    ğŸŒ <span id="langText">English</span>
  </button>
</div>

<h2 id="title">ØªØ³Ø¬ÙŠÙ„ Ø³Ø­Ø¨ Ø£ØµÙ†Ø§Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</h2>

<label for="driverId" id="labelDriver">Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ø³Ù…Ù‡:</label>
<input type="text" id="driverId" />

<label for="itemSelect" id="labelItem">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù:</label>
<select id="itemSelect"></select>

<label for="serialInput" id="labelSerial">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ ÙˆØ§Ø¶ØºØ· Enter:</label>
<input type="text" id="serialInput" />

<h3 id="addedItemsTitle">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø¶Ø§ÙØ©:</h3>
<div id="accumulatedItems">(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯)</div>

<button id="submitBtn">Ø¥Ø±Ø³Ø§Ù„</button>

<h3 id="previousEntriesTitle">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</h3>
<div id="previousEntries">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<script type="module">
  const langToggle = document.getElementById('langToggle');
  const langText = document.getElementById('langText');
  let currentLang = 'ar';

  const langStrings = {
    ar: {
      title: "ØªØ³Ø¬ÙŠÙ„ Ø³Ø­Ø¨ Ø£ØµÙ†Ø§Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†",
      driverLabel: "Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ø³Ù…Ù‡:",
      driverPlaceholder: "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø£Ùˆ Ø§Ø³Ù…Ù‡",
      itemLabel: "Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù:",
      itemOptions: ["-- Ø§Ø®ØªØ± ØµÙ†Ù --", "Ø´Ø§Ø´Ø©", "ÙƒÙŠØ¨Ù„", "Ø±Ø§ÙˆØªØ±", "Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­"],
      serialLabel: "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ ÙˆØ§Ø¶ØºØ· Enter:",
      serialPlaceholder: "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ù‡Ù†Ø§",
      addedItems: "Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø¶Ø§ÙØ©:",
      previousEntries: "Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:",
      submit: "Ø¥Ø±Ø³Ø§Ù„",
      toggleText: "English",
      dir: "rtl",
      textAlign: "right"
    },
    en: {
      title: "Warehouse Dispatch Form",
      driverLabel: "Driver Name or ID:",
      driverPlaceholder: "Enter Driver Name or ID",
      itemLabel: "Select Item:",
      itemOptions: ["-- Select Item --", "Screen", "Cable", "Router", "Keyboard"],
      serialLabel: "Enter Serial and press Enter:",
      serialPlaceholder: "Enter Serial Number Here",
      addedItems: "Added Items:",
      previousEntries: "Previous Records:",
      submit: "Submit",
      toggleText: "Ø¹Ø±Ø¨ÙŠ",
      dir: "ltr",
      textAlign: "left"
    }
  };

  function setLang(lang) {
    const t = langStrings[lang];
    document.body.dir = t.dir;
    document.body.style.textAlign = t.textAlign;

    // Align all inputs and selects
    const allFields = document.querySelectorAll('input, select, textarea');
    allFields.forEach(el => {
      el.style.direction = t.dir;
      el.style.textAlign = t.textAlign;
    });

    document.getElementById('title').innerText = t.title;
    document.getElementById('labelDriver').innerText = t.driverLabel;
    document.getElementById('driverId').placeholder = t.driverPlaceholder;

    document.getElementById('labelItem').innerText = t.itemLabel;
    const itemSelect = document.getElementById('itemSelect');
    itemSelect.innerHTML = '';
    t.itemOptions.forEach((text, index) => {
      const option = document.createElement('option');
      option.value = index === 0 ? '' : text;
      option.text = text;
      itemSelect.appendChild(option);
    });

    document.getElementById('labelSerial').innerText = t.serialLabel;
    document.getElementById('serialInput').placeholder = t.serialPlaceholder;

    document.getElementById('addedItemsTitle').innerText = t.addedItems;
    document.getElementById('previousEntriesTitle').innerText = t.previousEntries;
    document.getElementById('submitBtn').innerText = t.submit;
    langText.innerText = t.toggleText;
  }

  langToggle.addEventListener('click', () => {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    setLang(currentLang);
  });

  setLang('ar'); // default language

  // --- Serial input and accumulation logic ---

  const serialInput = document.getElementById('serialInput');
  const itemSelect = document.getElementById('itemSelect');
  const accumulatedItemsDiv = document.getElementById('accumulatedItems');
  const previousEntriesDiv = document.getElementById('previousEntries');
  const driverInput = document.getElementById('driverId');
  const submitBtn = document.getElementById('submitBtn');

  // Store items as array of objects: { item: string, serial: string }
  let accumulatedItems = [];

  function updateAccumulatedDisplay() {
    if(accumulatedItems.length === 0) {
      accumulatedItemsDiv.innerText = currentLang === 'ar' ? '(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯)' : '(No data yet)';
      return;
    }
    // Group by item type
    const grouped = {};
    accumulatedItems.forEach(({ item, serial }) => {
      if (!grouped[item]) grouped[item] = [];
      grouped[item].push(`<${serial}>`);
    });

    let displayText = '';
    for (const item in grouped) {
      displayText += `- ${item} â€” ${currentLang === 'ar' ? 'Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„' : 'Serial'}: ${grouped[item].join(' ')}\n`;
    }
    accumulatedItemsDiv.innerText = displayText;
  }

  // On pressing Enter in serial input
  serialInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      e.preventDefault();
      const serial = serialInput.value.trim();
      const item = itemSelect.value;
      if(serial && item) {
        accumulatedItems.push({ item, serial });
        updateAccumulatedDisplay();
        serialInput.value = '';
      } else {
        alert(currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ†Ù ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„' : 'Please select an item and enter serial number');
      }
    }
  });

  // Submit accumulated items
  submitBtn.addEventListener('click', () => {
    const driver = driverInput.value.trim();
    if(!driver) {
      alert(currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚' : 'Please enter driver name or ID');
      return;
    }
    if(accumulatedItems.length === 0) {
      alert(currentLang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø¶Ø§ÙØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„' : 'No items added to submit');
      return;
    }

    // Format the record text
    const now = new Date().toLocaleString(currentLang === 'ar' ? 'ar-EG' : 'en-US');
    let grouped = {};
    accumulatedItems.forEach(({ item, serial }) => {
      if(!grouped[item]) grouped[item] = [];
      grouped[item].push(`<${serial}>`);
    });

    let details = '';
    for (const item in grouped) {
      details += `- ${item} â€” ${currentLang === 'ar' ? 'Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„' : 'Serial'}: ${grouped[item].join(' ')}\n`;
    }

    const recordText = `${currentLang === 'ar' ? 'Ø§Ù„ØªØ§Ø±ÙŠØ®' : 'Date'}: ${now}\n${currentLang === 'ar' ? 'Ø§Ù„Ø³Ø§Ø¦Ù‚' : 'Driver'}: ${driver}\n${currentLang === 'ar' ? 'Ø§Ù„Ø£ØµÙ†Ø§Ù' : 'Items'}:\n${details}`;

    // Save to Firebase Firestore
    const db = firebase.firestore();
    db.collection("warehouseEntries").add({ timestamp: now, entry: recordText })
      .then(() => {
        alert(currentLang === 'ar' ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'Submitted successfully');
        accumulatedItems = [];
        updateAccumulatedDisplay();
        loadPreviousEntries();
      })
      .catch(err => {
        alert(currentLang === 'ar' ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'Error while submitting');
        console.error(err);
      });
  });

  // Function to load previous entries from Firestore
  function loadPreviousEntries() {
    const db = firebase.firestore();
    previousEntriesDiv.innerText = currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'Loading...';
    db.collection("warehouseEntries").orderBy("timestamp", "desc").get()
      .then(snapshot => {
        if(snapshot.empty) {
          previousEntriesDiv.innerText = currentLang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯' : 'No records yet';
          return;
        }
        previousEntriesDiv.innerText = '';
        snapshot.forEach(doc => {
          const pre = document.createElement('pre');
          pre.style.textAlign = currentLang === 'ar' ? 'right' : 'left';
          pre.textContent = doc.data().entry;
          previousEntriesDiv.appendChild(pre);
        });
      })
      .catch(err => {
        previousEntriesDiv.innerText = currentLang === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª' : 'Error loading records';
        console.error(err);
      });
  }

  loadPreviousEntries();

</script>

</body>
</html>
