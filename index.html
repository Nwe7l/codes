<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Warehouse Dispatch Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
    .section {
      margin-bottom: 20px;
    }
    .item-buttons button {
      margin: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #444;
      color: white;
    }
    tr.expandable {
      background-color: #e9e9e9;
      cursor: pointer;
    }
    tr.details {
      display: none;
      background-color: #fdfdfd;
    }
    .thumbnail {
      height: 40px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>Warehouse Dispatch Tracker</h1>

<div class="section">
  <h3>Step 1: Driver Info</h3>
  <input type="text" id="driverId" placeholder="Driver ID (optional)" />
  <input type="file" id="driverImage" accept="image/*" />
  <button onclick="submitDriver()">Submit Driver</button>
</div>

<div class="section" id="itemsSection" style="display: none;">
  <h3>Step 2: Select Items</h3>
  <div class="item-buttons">
    <button onclick="selectItem('Screen')">Screen</button>
    <button onclick="selectItem('Router')">Router</button>
    <button onclick="selectItem('Cable')">Cable</button>
    <button onclick="selectItem('Laptop')">Laptop</button>
  </div>
  <div id="serialSection" style="display: none;">
    <strong>Selected Item:</strong> <span id="currentItem"></span>
    <input type="text" id="serialInput" placeholder="Enter Serial Number" />
    <button onclick="addSerial()">Add</button>
  </div>
</div>

<div class="section">
  <h3>All Dispatches</h3>
  <table id="logTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Click to Expand</th>
      </tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>
</div>

<script>
  let currentDriver = { id: '', image: '', date: '', items: [] };
  let allDispatches = [];

  function loadData() {
    const stored = localStorage.getItem("dispatchData");
    if (stored) {
      allDispatches = JSON.parse(stored);
      renderTable();
    }
  }

  function saveData() {
    localStorage.setItem("dispatchData", JSON.stringify(allDispatches));
  }

  function submitDriver() {
    const idInput = document.getElementById("driverId").value.trim();
    const imageInput = document.getElementById("driverImage");

    if (!idInput && imageInput.files.length === 0) {
      alert("Enter driver ID or upload image");
      return;
    }

    const now = new Date();
    const dateStr = now.toLocaleString();

    currentDriver = {
      id: idInput || '—',
      image: '',
      date: dateStr,
      items: []
    };

    if (imageInput.files.length > 0) {
      const reader = new FileReader();
      reader.onload = function (e) {
        currentDriver.image = e.target.result;
        document.getElementById("itemsSection").style.display = 'block';
      };
      reader.readAsDataURL(imageInput.files[0]);
    } else {
      document.getElementById("itemsSection").style.display = 'block';
    }
  }

  function selectItem(itemName) {
    document.getElementById("currentItem").textContent = itemName;
    document.getElementById("serialSection").style.display = 'inline';
    document.getElementById("serialInput").dataset.item = itemName;
  }

  function addSerial() {
    const item = document.getElementById("serialInput").dataset.item;
    const serial = document.getElementById("serialInput").value.trim();
    if (!serial) return alert("Enter a serial number");

    currentDriver.items.push({ item, serial });
    document.getElementById("serialInput").value = '';

    // Save only after first serial is added
    const alreadySaved = allDispatches.some(d => d.date === currentDriver.date);
    if (!alreadySaved) {
      allDispatches.push(JSON.parse(JSON.stringify(currentDriver)));
    }

    // Update matching dispatch if exists
    const index = allDispatches.findIndex(d => d.date === currentDriver.date);
    allDispatches[index] = JSON.parse(JSON.stringify(currentDriver));

    saveData();
    renderTable();
  }

  function renderTable() {
    const tbody = document.getElementById("logBody");
    tbody.innerHTML = "";

    allDispatches.forEach((dispatch, index) => {
      const row = document.createElement("tr");
      row.className = "expandable";
      row.innerHTML = `<td>${dispatch.date}</td><td>Click to view</td>`;
      row.onclick = () => {
        const details = document.getElementById(`details-${index}`);
        details.style.display = details.style.display === "none" ? "table-row" : "none";
      };

      const detailsRow = document.createElement("tr");
      detailsRow.className = "details";
      detailsRow.id = `details-${index}`;

      let html = `<strong>Driver ID:</strong> ${dispatch.id}<br>`;
      if (dispatch.image) {
        html += `<img class="thumbnail" src="${dispatch.image}" /><br>`;
      }
      dispatch.items.forEach(item => {
        html += `• <b>${item.item}</b> — ${item.serial}<br>`;
      });

      detailsRow.innerHTML = `<td colspan="2">${html}</td>`;

      tbody.appendChild(row);
      tbody.appendChild(detailsRow);
    });
  }

  // Load existing data on start
  window.onload = loadData;
</script>

</body>
</html>
