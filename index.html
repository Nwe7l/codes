<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تسجيل سحب أصناف من المخزن</title>
<style>
  body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; background: #f9f9f9; }
  label, select, input, button { display: block; width: 100%; margin-bottom: 10px; font-size: 1rem; padding: 8px; box-sizing: border-box; }
  button { background: #007bff; color: #fff; border: none; cursor: pointer; }
  button:hover { background: #0056b3; }
  #accumulatedItems, #previousEntries { white-space: pre-wrap; background: #fff; border: 1px solid #ccc; padding: 10px; min-height: 80px; margin-bottom: 20px; position: relative; }
  .entry-box { background: #f0f0f0; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; white-space: normal; position: relative; }
  .delete-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #dc3545;
    color: white;
    border: none;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.9rem;
    border-radius: 4px;
  }
  .delete-btn:hover {
    background: #a71d2a;
  }
  h3 { margin-top: 30px; }
</style>
</head>
<body>

<h2>تسجيل سحب أصناف من المخزن</h2>

<label for="driverId">رقم السائق أو اسمه:</label>
<input type="text" id="driverId" placeholder="أدخل رقم السائق أو اسمه" />

<label for="itemSelect">اختر الصنف:</label>
<select id="itemSelect">
  <option value="">-- اختر صنف --</option>
  <option value="Screen">Screen</option>
  <option value="Cable">Cable</option>
  <option value="Router">Router</option>
  <option value="Keyboard">Keyboard</option>
</select>

<label for="serialInput">أدخل رقم السيريال واضغط Enter:</label>
<input type="text" id="serialInput" placeholder="أدخل رقم السيريال هنا" />

<h3>الأصناف المضافة:</h3>
<div id="accumulatedItems">(لا توجد بيانات بعد)</div>

<button id="submitBtn" style="margin-top:20px;">إرسال</button>

<h3>السجلات السابقة:</h3>
<div id="previousEntries">جاري التحميل...</div>

<script type="module">
// Firebase إعدادات
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBJKet_uwrNKLRzJuZBNbgtJzSJ963vpmM",
  authDomain: "code-64718.firebaseapp.com",
  projectId: "code-64718",
  storageBucket: "code-64718.firebasestorage.app",
  messagingSenderId: "976088837146",
  appId: "1:976088837146:web:755a0643e01d2d45d175a3",
  measurementId: "G-XFE7T9Q87M"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// عناصر الصفحة
const driverInput = document.getElementById('driverId');
const itemSelect = document.getElementById('itemSelect');
const serialInput = document.getElementById('serialInput');
const accumulatedItemsDiv = document.getElementById('accumulatedItems');
const submitBtn = document.getElementById('submitBtn');
const previousEntriesDiv = document.getElementById('previousEntries');

// لتخزين الأصناف والسيريالات مؤقتاً
const entries = {};

// تحديث عرض الأصناف المضافة
function updateDisplay() {
  if (Object.keys(entries).length === 0) {
    accumulatedItemsDiv.textContent = "(لا توجد بيانات بعد)";
    return;
  }
  let displayText = "";
  for (const [item, serials] of Object.entries(entries)) {
    displayText += `- ${item} — السيريال: ${serials.map(s => `<${s}>`).join(" ")}\n`;
  }
  accumulatedItemsDiv.textContent = displayText.trim();
}

// إضافة السيريال عند الضغط Enter
serialInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const item = itemSelect.value.trim();
    const serial = serialInput.value.trim();
    if (!item) {
      alert("يرجى اختيار صنف أولاً");
      return;
    }
    if (!serial) {
      alert("يرجى إدخال رقم السيريال");
      return;
    }
    if (!entries[item]) {
      entries[item] = [];
    }
    if (!entries[item].includes(serial)) {
      entries[item].push(serial);
      updateDisplay();
    }
    serialInput.value = '';
  }
});

// إرسال البيانات إلى Firestore
submitBtn.addEventListener('click', async () => {
  const driver = driverInput.value.trim();
  if (!driver) {
    alert("يرجى إدخال رقم أو اسم السائق");
    return;
  }
  if (Object.keys(entries).length === 0) {
    alert("يرجى إدخال صنف واحد على الأقل مع رقم/أرقام السيريال");
    return;
  }

  try {
    await addDoc(collection(db, "warehouseEntries"), {
      driver,
      items: entries,
      createdAt: serverTimestamp()
    });
    alert("تم الحفظ!");
    // إعادة تعيين الحقول
    driverInput.value = '';
    itemSelect.value = '';
    serialInput.value = '';
    for (const key in entries) {
      delete entries[key];
    }
    updateDisplay();
  } catch (error) {
    alert("حدث خطأ أثناء الحفظ: " + error.message);
  }
});

// تحميل وعرض السجلات السابقة مع تحديث مباشر + إضافة زر حذف
function formatDate(timestamp) {
  if (!timestamp) return "";
  const d = timestamp.toDate();
  return d.toLocaleString("ar-EG");
}

function renderEntries(docs) {
  if (docs.length === 0) {
    previousEntriesDiv.textContent = "لا توجد سجلات سابقة.";
    return;
  }
  previousEntriesDiv.innerHTML = ""; // تنظيف المحتوى القديم
  docs.forEach(docSnap => {
    const data = docSnap.data();
    const entryDiv = document.createElement('div');
    entryDiv.className = "entry-box";

    // نص السجل
    let entryText = `التاريخ: ${formatDate(data.createdAt)}\n`;
    entryText += `السائق: ${data.driver}\n`;
    entryText += `الأصناف:\n`;
    for (const [item, serials] of Object.entries(data.items)) {
      entryText += `- ${item} — السيريال: ${serials.map(s => `<${s}>`).join(" ")}\n`;
    }

    // إنشاء عنصر نصي مع احترام الأسطر
    const pre = document.createElement('pre');
    pre.textContent = entryText.trim();
    entryDiv.appendChild(pre);

    // زر الحذف
    const delBtn = document.createElement('button');
    delBtn.textContent = "حذف";
    delBtn.className = "delete-btn";
    delBtn.addEventListener('click', async () => {
      if (confirm("هل أنت متأكد أنك تريد حذف هذا السجل؟")) {
        try {
          await deleteDoc(doc(db, "warehouseEntries", docSnap.id));
          alert("تم حذف السجل.");
        } catch (err) {
          alert("خطأ أثناء الحذف: " + err.message);
        }
      }
    });
    entryDiv.appendChild(delBtn);

    previousEntriesDiv.appendChild(entryDiv);
  });
}

// استماع مباشر على التحديثات الأخيرة (آخر 50 سجل)
const q = query(collection(db, "warehouseEntries"), orderBy("createdAt", "desc"));
onSnapshot(q, (querySnapshot) => {
  renderEntries(querySnapshot.docs);
});

</script>

</body>
</html>
