<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>مخزن - خروج مواد متعدد</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJKet_uwrNKLRzJuZBNbgtJzSJ963vpmM",
      authDomain: "code-64718.firebaseapp.com",
      projectId: "code-64718",
      storageBucket: "code-64718.appspot.com",
      messagingSenderId: "976088837146",
      appId: "1:976088837146:web:755a0643e01d2d45d175a3",
      measurementId: "G-XFE7T9Q87M"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Items list for dropdown
    const availableItems = ["Screen", "Router", "Cable", "Power Adapter"];

    document.addEventListener("DOMContentLoaded", () => {
      setupItemsSection();
      loadEntries();
    });

    function setupItemsSection() {
      const container = document.getElementById("itemsContainer");
      addItemInput(container); // add one item input block initially

      document.getElementById("addItemBtn").addEventListener("click", () => {
        addItemInput(container);
      });
    }

    // Add one item input block: dropdown + serial input + serial preview
    function addItemInput(container) {
      const index = container.children.length;
      const div = document.createElement("div");
      div.className = "item-block";

      // Create item select
      const select = document.createElement("select");
      select.name = `item_${index}`;
      select.innerHTML = `<option value="">-- اختر المادة --</option>` + availableItems.map(i => `<option>${i}</option>`).join("");
      div.appendChild(select);

      // Serial input
      const serialInput = document.createElement("input");
      serialInput.type = "text";
      serialInput.placeholder = "أدخل رقم السيريال واضغط Enter";
      serialInput.name = `serialInput_${index}`;
      div.appendChild(serialInput);

      // Serial preview container
      const preview = document.createElement("div");
      preview.className = "serial-preview";
      div.appendChild(preview);

      // Serial list array for this block
      let serialList = [];

      serialInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = serialInput.value.trim();
          if (val) {
            serialList.push(val);
            preview.innerHTML = serialList.map(s => `<span class="tag">&lt;${s}&gt;</span>`).join(" ");
            serialInput.value = "";
          }
        }
      });

      // Store serial list array on the div for later retrieval
      div.serialList = serialList;

      container.appendChild(div);
    }

    async function submitForm() {
      const driverId = document.getElementById("driverId").value.trim();
      const file = document.getElementById("driverImage").files[0];

      if (!driverId && !file) {
        alert("يرجى إدخال رقم السائق أو رفع صورة");
        return;
      }

      // Collect all items and their serials
      const container = document.getElementById("itemsContainer");
      const itemBlocks = container.querySelectorAll(".item-block");

      const items = [];

      for (const block of itemBlocks) {
        const select = block.querySelector("select");
        const itemName = select.value;
        if (!itemName) continue; // skip empty

        const serials = block.serialList || [];
        if (serials.length === 0) {
          alert(`يرجى إدخال رقم أو أكثر للسيريال للصنف: ${itemName}`);
          return;
        }

        items.push({ item: itemName, serials });
      }

      if (items.length === 0) {
        alert("يرجى إضافة صنف واحد على الأقل مع السيريال");
        return;
      }

      // Upload image if any
      let imageUrl = "";
      if (file) {
        const fileRef = ref(storage, 'driverImages/' + file.name + "_" + Date.now());
        const snapshot = await uploadBytes(fileRef, file);
        imageUrl = await getDownloadURL(snapshot.ref);
      }

      // Save one document per driver+timestamp with all items array
      await addDoc(collection(db, "dispatch"), {
        driverId: driverId || "",
        imageUrl,
        items,
        timestamp: serverTimestamp()
      });

      alert("تم الحفظ!");
      clearForm();
      loadEntries();
    }

    function clearForm() {
      document.getElementById("driverId").value = "";
      document.getElementById("driverImage").value = "";

      const container = document.getElementById("itemsContainer");
      container.innerHTML = "";
      setupItemsSection();
    }

    async function loadEntries() {
      const entryList = document.getElementById("entryList");
      entryList.innerHTML = "جاري التحميل...";

      const querySnapshot = await getDocs(collection(db, "dispatch"));
      const entries = [];

      querySnapshot.forEach(doc => {
        const d = doc.data();
        entries.push({ id: doc.id, ...d });
      });

      if (entries.length === 0) {
        entryList.innerHTML = "لا توجد بيانات بعد.";
        return;
      }

      // عرض كل سجل (كل سجل يحتوي على driverId + items[])
      let html = "";
      entries.sort((a,b) => {
        if(!a.timestamp) return 1;
        if(!b.timestamp) return -1;
        return b.timestamp.toDate() - a.timestamp.toDate();
      });

      for (const e of entries) {
        const dateStr = e.timestamp ? e.timestamp.toDate().toISOString().split("T")[0] : "بدون تاريخ";
        const driver = e.driverId || (e.imageUrl ? "بصورة فقط" : "غير معروف");

        html += `<div class="entry-box">
          <b>التاريخ:</b> ${dateStr} <br>
          <b>السائق:</b> ${driver} <br>
          <b>الأصناف:</b><br><ul>`;

        e.items.forEach(it => {
          const serialsFormatted = it.serials.map(s => `&lt;${s}&gt;`).join(" ");
          html += `<li>${it.item} — السيريال: ${serialsFormatted}</li>`;
        });

        html += "</ul></div><br>";
      }

      entryList.innerHTML = html;
    }

    window.submitForm = submitForm;
  </script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f3f3f3;
      padding: 20px;
      direction: rtl;
    }
    input, select, button, textarea {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    .entry-box {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .tag {
      display: inline-block;
      background: #d0eaff;
      padding: 5px 10px;
      margin: 3px;
      border-radius: 6px;
      color: #0073aa;
      font-weight: bold;
    }
    .serial-preview {
      margin: 5px 0 10px 0;
      min-height: 25px;
    }
    .item-block {
      margin-bottom: 15px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: white;
    }
  </style>
</head>
<body>

  <h2>خروج مواد من المخزن</h2>

  <input type="text" id="driverId" placeholder="رقم السائق (اختياري إذا أرفقت صورة)" />
  <input type="file" id="driverImage" accept="image/*" />

  <div id="itemsContainer"></div>
  <button id="addItemBtn" type="button">+ إضافة صنف جديد</button>

  <button onclick="submitForm()">إرسال</button>

  <hr>
  <h3>السجلات السابقة</h3>
  <div id="entryList"></div>

</body>
</html>
